/*****************************************************
 *Author :	 Moatasem								*
 *Date:  	 12/10/2018								*
 *Version:	 v02									*
 *Brief:		 TFT Module								*
 ******************************************************/
#include "TFT.h"

#include <util/delay.h>
#include <GPIO.h>
#include <SPI.h>
static void TFT_WriteCommand(uint8 Copy_uint8Command);
static void TFT_WriteData   (uint8 Copy_uint8Data);
//static void TFT_DrawPixel (uint16 copyX , uint16 copyY , uint16 copy_Colour);

static const uint8 TFT_font[96][6] = {
	{0x00,0x00,0x00,0x00,0x00,0x00}, //
	{0x5c,0x00,0x00,0x00,0x00,0x00}, // !
	{0x06,0x00,0x06,0x00,0x00,0x00}, // "
	{0x28,0x7c,0x28,0x7c,0x28,0x00}, // #
	{0x5c,0x54,0xfe,0x54,0x74,0x00}, // $
	{0x44,0x20,0x10,0x08,0x44,0x00}, // %
	{0x28,0x54,0x54,0x20,0x50,0x00}, // &
	{0x06,0x00,0x00,0x00,0x00,0x00}, // '
	{0x38,0x44,0x00,0x00,0x00,0x00}, // (
	{0x44,0x38,0x00,0x00,0x00,0x00}, // )
	{0x02,0x07,0x02,0x00,0x00,0x00}, // *
	{0x10,0x10,0x7c,0x10,0x10,0x00}, // +
	{0xc0,0x00,0x00,0x00,0x00,0x00}, // ,
	{0x10,0x10,0x10,0x10,0x10,0x00}, // -
	{0x40,0x00,0x00,0x00,0x00,0x00}, // .
	{0x60,0x10,0x0c,0x00,0x00,0x00}, // /
	{0x7c,0x64,0x54,0x4c,0x7c,0x00}, // 0
	{0x48,0x7c,0x40,0x00,0x00,0x00}, // 1
	{0x64,0x54,0x54,0x54,0x48,0x00}, // 2
	{0x44,0x54,0x54,0x54,0x6c,0x00}, // 3
	{0x3c,0x20,0x70,0x20,0x20,0x00}, // 4
	{0x5c,0x54,0x54,0x54,0x24,0x00}, // 5
	{0x7c,0x54,0x54,0x54,0x74,0x00}, // 6
	{0x04,0x04,0x64,0x14,0x0c,0x00}, // 7
	{0x7c,0x54,0x54,0x54,0x7c,0x00}, // 8
	{0x5c,0x54,0x54,0x54,0x7c,0x00}, // 9
	{0x44,0x00,0x00,0x00,0x00,0x00}, // :
	{0xc4,0x00,0x00,0x00,0x00,0x00}, // ;
	{0x10,0x28,0x44,0x00,0x00,0x00}, // <
	{0x28,0x28,0x28,0x28,0x28,0x00}, // =
	{0x44,0x28,0x10,0x00,0x00,0x00}, // >
	{0x08,0x04,0x54,0x08,0x00,0x00}, // ?
	{0x7c,0x44,0x54,0x54,0x5c,0x00}, // @
	{0x7c,0x24,0x24,0x24,0x7c,0x00}, // A
	{0x7c,0x54,0x54,0x54,0x6c,0x00}, // B
	{0x7c,0x44,0x44,0x44,0x44,0x00}, // C
	{0x7c,0x44,0x44,0x44,0x38,0x00}, // D
	{0x7c,0x54,0x54,0x54,0x44,0x00}, // E
	{0x7c,0x14,0x14,0x14,0x04,0x00}, // F
	{0x7c,0x44,0x44,0x54,0x74,0x00}, // G
	{0x7c,0x10,0x10,0x10,0x7c,0x00}, // H
	{0x44,0x44,0x7c,0x44,0x44,0x00}, // I
	{0x60,0x40,0x40,0x44,0x7c,0x00}, // J
	{0x7c,0x10,0x10,0x28,0x44,0x00}, // K
	{0x7c,0x40,0x40,0x40,0x40,0x00}, // L
	{0x7c,0x08,0x10,0x08,0x7c,0x00}, // M
	{0x7c,0x08,0x10,0x20,0x7c,0x00}, // N
	{0x38,0x44,0x44,0x44,0x38,0x00}, // O
	{0x7c,0x14,0x14,0x14,0x08,0x00}, // P
	{0x3c,0x24,0x64,0x24,0x3c,0x00}, // Q
	{0x7c,0x14,0x14,0x14,0x68,0x00}, // R
	{0x5c,0x54,0x54,0x54,0x74,0x00}, // S
	{0x04,0x04,0x7c,0x04,0x04,0x00}, // T
	{0x7c,0x40,0x40,0x40,0x7c,0x00}, // U
	{0x0c,0x30,0x40,0x30,0x0c,0x00}, // V
	{0x3c,0x40,0x30,0x40,0x3c,0x00}, // W
	{0x44,0x28,0x10,0x28,0x44,0x00}, // X
	{0x0c,0x10,0x60,0x10,0x0c,0x00}, // Y
	{0x44,0x64,0x54,0x4c,0x44,0x00}, // Z
	{0x7c,0x44,0x00,0x00,0x00,0x00}, // [
	{0x0c,0x10,0x60,0x00,0x00,0x00}, // "\"
	{0x44,0x7c,0x00,0x00,0x00,0x00}, // ]
	{0x00,0x01,0x00,0x01,0x00,0x00}, // ^
	{0x40,0x40,0x40,0x40,0x40,0x40}, // _
	{0x00,0x01,0x00,0x00,0x00,0x00}, // `
	{0x7c,0x24,0x24,0x24,0x7c,0x00}, // a
	{0x7c,0x54,0x54,0x54,0x6c,0x00}, // b
	{0x7c,0x44,0x44,0x44,0x44,0x00}, // c
	{0x7c,0x44,0x44,0x44,0x38,0x00}, // d
	{0x7c,0x54,0x54,0x54,0x44,0x00}, // e
	{0x7c,0x14,0x14,0x14,0x04,0x00}, // f
	{0x7c,0x44,0x44,0x54,0x74,0x00}, // g
	{0x7c,0x10,0x10,0x10,0x7c,0x00}, // h
	{0x44,0x44,0x7c,0x44,0x44,0x00}, // i
	{0x60,0x40,0x40,0x44,0x7c,0x00}, // j
	{0x7c,0x10,0x10,0x28,0x44,0x00}, // k
	{0x7c,0x40,0x40,0x40,0x40,0x00}, // l
	{0x7c,0x08,0x10,0x08,0x7c,0x00}, // m
	{0x7c,0x08,0x10,0x20,0x7c,0x00}, // n
	{0x38,0x44,0x44,0x44,0x38,0x00}, // o
	{0x7c,0x14,0x14,0x14,0x08,0x00}, // p
	{0x3c,0x24,0x64,0x24,0x3c,0x00}, // q
	{0x7c,0x14,0x14,0x14,0x68,0x00}, // r
	{0x5c,0x54,0x54,0x54,0x74,0x00}, // s
	{0x04,0x04,0x7c,0x04,0x04,0x00}, // t
	{0x7c,0x40,0x40,0x40,0x7c,0x00}, // u
	{0x0c,0x30,0x40,0x30,0x0c,0x00}, // v
	{0x3c,0x40,0x30,0x40,0x3c,0x00}, // w
	{0x44,0x28,0x10,0x28,0x44,0x00}, // x
	{0x0c,0x10,0x60,0x10,0x0c,0x00}, // y
	{0x44,0x64,0x54,0x4c,0x44,0x00}, // z
	{0x10,0x7c,0x44,0x00,0x00,0x00}, // {
	{0x6c,0x00,0x00,0x00,0x00,0x00}, // |
	{0x44,0x7c,0x10,0x00,0x00,0x00}, // }
	{0x02,0x01,0x02,0x01,0x00,0x00}, // ~
	{0x00,0x00,0x00,0x00,0x00,0x00}
};

void TFT_init(){
	GPIO_init_pin( Data_COMMAND_PIN,GPIO_OUTPUT);
	GPIO_init_pin( SCK_PIN,GPIO_OUTPUT);
	GPIO_init_pin( MOSI_PIN,GPIO_OUTPUT);
	GPIO_init_pin( CS_PIN,GPIO_OUTPUT);
	GPIO_init_pin( RST_PIN,GPIO_OUTPUT);

	GPIO_write_pin(RST_PIN , HIGH);
	_delay_us(100);
	GPIO_write_pin (RST_PIN , LOW);
	_delay_us(2);
	GPIO_write_pin (RST_PIN , HIGH);
	_delay_us(100);
	GPIO_write_pin (RST_PIN , LOW);
	_delay_us(100);
	GPIO_write_pin (RST_PIN , HIGH);
	_delay_ms(120);

	GPIO_write_pin( CS_PIN,HIGH);
	SPI_Init();

	/* Sleep out */
	TFT_WriteCommand(0x11);

	/* Wait 150 ms */
	_delay_ms(150 );
	/* Colour mode command */
	TFT_WriteCommand(0x3A);
	TFT_WriteData(0x05);//RGB565

	/* Display on */
	TFT_WriteCommand(0x29);
}

static void TFT_WriteCommand(uint8 Copy_Command)
{

	GPIO_write_pin( CS_PIN,LOW); 			//enable the slave
	GPIO_write_pin(Data_COMMAND_PIN,LOW); 	//set the command mode
	SPI_Write(Copy_Command);				//send the command through spi
	GPIO_write_pin( CS_PIN,HIGH);			//disable the slave
}
static void TFT_WriteData   (uint8 Copy_Data)
{
	GPIO_write_pin( CS_PIN,LOW);           	//enable the slave
	GPIO_write_pin(Data_COMMAND_PIN,HIGH);  //set the data mode
	SPI_Write(Copy_Data);					//send the data through spi
	GPIO_write_pin( CS_PIN,HIGH);			//disable the slave
}

void TFT_DrawRectangle (uint16 copyX ,uint16 copyY , uint16 copyWidth , uint16 copy_Hight , uint16 copyColor ){
	uint16 loacal_EndX = copyX + copyWidth - 1;
	uint16 loacal_EndY = copyY + copy_Hight - 1;

	/* Set area of addresses */
	TFT_SetAddress(copyX ,loacal_EndX,copyY ,loacal_EndY );

	/* Draw the Rectangle*/
	for (uint16 i = 0 ; i < (copyWidth *copy_Hight ) ; i++){
		TFT_SetColour(copyColor);
	}
}
 void TFT_SetAddress (uint16 copy_StartX ,uint16 copy_EndX , uint16 copy_StartY , uint16 copy_EndY)
{
	if ( (copy_StartX < TFT_MAX_X ) && (copy_StartY < TFT_MAX_Y )){
		/* Set x Address */
		TFT_WriteCommand(0x2A);
		/* Start byte */
		TFT_WriteData((copy_StartX >> 8));  // MS byte
		TFT_WriteData(copy_StartX);

		/* Stop byte */
		TFT_WriteData((copy_EndX >> 8));
		TFT_WriteData(copy_EndX);

		/* Set x Address */
		TFT_WriteCommand(0x2B);
		/* Start byte */
		TFT_WriteData((copy_StartY >> 8));  // MS byte
		TFT_WriteData(copy_StartY);
		/* Stop byte */
		TFT_WriteData((copy_EndY >> 8));
		TFT_WriteData(copy_EndY);

		/* RAM write */
		TFT_WriteCommand(0x2C);
	}
}

void TFT_SetColour(uint16 copy_Colour)
{

	/* Write pixel */
	uint8 high_byte = (copy_Colour >> 8);
	uint8 low_byte = (copy_Colour & 0xff);
	TFT_WriteData(high_byte);
	TFT_WriteData(low_byte);
}

void TFT_DisplayImage (const uint16* Copy_Image)
{	/* Set address range for the whole display */
	uint16 counter;
	uint8 Data;

		/* Set X Address */
		TFT_WriteCommand(0x2A);
		TFT_WriteData(0);
		TFT_WriteData(0);
		TFT_WriteData(0);
		TFT_WriteData(19);

		/* Set Y Address */
		TFT_WriteCommand(0x2B);
		TFT_WriteData(0);
		TFT_WriteData(0);
		TFT_WriteData(0);
		TFT_WriteData(19);

		/* RAM Write */
		TFT_WriteCommand(0x2C);

		for(counter = 0; counter< 400;counter++)
		{
			Data = Copy_Image[counter] >> 8;

			/* Write the high byte */
			TFT_WriteData(Data);
			/* Write the low byte */
			Data = Copy_Image[counter] & 0x00ff;
			TFT_WriteData(Data);
		}

}
void TFT_voidPrintChar(sint8 copy_Char , uint16 copyX , uint16 copyY, uint8 copy_Size , uint16 copyColor , uint16 copy_BackColor)
{
	/* Get array index */
	uint8 local_uint8CharIndex = 0 ;
	if (( copy_Char >= ' ' )){
		local_uint8CharIndex = copy_Char - 32 ;
	}

	/* Background */
	TFT_DrawRectangle( copyX, copyY ,copy_Size*TFT_CHARACTER_WIDTH ,copy_Size*TFT_CHARACTER_HIGHT ,copy_BackColor);

	for (uint8 i = 0; i <TFT_CHARACTER_WIDTH ; i++ ){
		for (uint8 j = 0 ; j <TFT_CHARACTER_HIGHT ; j++){
			if (TFT_font[local_uint8CharIndex][i] & (1 << j)){
				if (copy_Size == 1){
					TFT_DrawPixel(copyX+i , copyY+j , copyColor);
				}
				else {
					uint16 local_x = copyX+(i*copy_Size) ;
					uint16 local_y = copyY+(j*copy_Size) ;
					TFT_DrawRectangle( local_x, local_y ,copy_Size ,copy_Size ,copyColor);
				}
			}
		}
	}
}
 void TFT_DrawPixel (uint16 copyX , uint16 copyY , uint16 copy_Colour)
{
	if ( (copyX < TFT_MAX_X ) && (copyY < TFT_MAX_Y )){

		/* Set address of the pixel */
		TFT_SetAddress(copyX  , copyX+1 , copyY , copyY+1);

		/* Write pixel colour */
		TFT_SetColour(copy_Colour);
	}
}
void TFT_Printtext(sint8* copy_Char , uint16 copyX , uint16 copyY, uint8 copy_Size , uint16 copyColor , uint16 copy_BackColor)
{
	uint8 i=0;
	while(copy_Char[i]!=0)
	{
		TFT_voidPrintChar(copy_Char[i], copyX+(i*12), copyY, copy_Size, copyColor, copy_BackColor);
	i++;
	}
}
void TFT_CLEAR()
{
	TFT_DrawRectangle( 10, 30 ,215 ,180 ,TFT_WHITE);

}

